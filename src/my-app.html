<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">


<link rel="import" href="./shared-styles.html">
<link rel="import" href="./components/drawer/mk-drawer.html">

<link rel="lazy-import" href="./pages/page-login.html">
<link rel="lazy-import" href="./pages/page-not-found.html">
<link rel="lazy-import" href="./pages/page-dashboard.html">

<dom-module id="my-app">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
                color: var(--mk-primary-color);
                --app-drawer-width: 256px;
                --app-header-height: 48px;
            }

            :host([drawer-minimized]) {
                --app-drawer-width: 48px;
            }

            :host([narrow]) {
                --app-drawer-width: 256px;
            }

            app-drawer,
            app-header-layout {
                transition: all 0.5s;
                overflow: hidden;
            }

            iron-pages {
                width: 100%;
                height: 100vh;
            }
        </style>

        <!-- Firebase config -->
        <firebase-app 
            auth-domain="projectmykanban.firebaseapp.com" 
            database-url="https://projectmykanban.firebaseio.com/" 
            api-key="AIzaSyBSuh-1xzT6XsxP7CGNZxzjSdP-0wyFvgk"
            storage-bucket="projectmykanban.appspot.com" 
            messaging-sender-id="63907430852">
        </firebase-app>

        <!-- Firebase Authentication -->
        <firebase-auth 
            id="auth" 
            user="{{user}}">
        </firebase-auth>

        <!-- Router -->
        <app-location 
            route="{{route}}" 
            url-space-regex="^[[rootPath]]">
        </app-location>

        <app-route 
            route="{{route}}" 
            pattern="[[rootPath]]:page" 
            data="{{routeData}}" 
            tail="{{subroute}}">
        </app-route>


        <!-- MAIN APP -->

        <app-drawer-layout fullbleed narrow="{{narrow}}">

            <!-- Drawer content -->
            <app-drawer id="drawer" slot="drawer" swipe-open="[[narrow]]">
                <mk-drawer minimized="{{drawerMinimized}}" narrow="[[narrow]]"></mk-drawer>
            </app-drawer>

            <!-- Main content -->
            <app-header-layout has-scrolling-region>

                <!-- a global header on moblie -->
                <template is="dom-if" if="[[narrow]]">
                    <app-header class="app-shadow-4" slot="header" condenses reveals effects="waterfall">
                        <app-toolbar>
                            <paper-icon-button icon="icons:menu" drawer-toggle></paper-icon-button>
                            <div main-title>My App</div>
                        </app-toolbar>
                    </app-header>
                </template>

                <!-- All possible pages for lazy load -->
                <iron-pages selected="[[page]]" attr-for-selected="name" fallback-selection="not-found" role="main">
                    <page-not-found name="not-found"></page-not-found>
                    <page-login name="login"></page-login>
                    <page-dashboard name="dashboard"></page-dashboard>
                </iron-pages>

                <paper-toast id="mainToast"></paper-toast>

                <paper-dialog id="mainDialog" modal>
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                    <div class="buttons">
                      <paper-button dialog-confirm autofocus>Tap me to close</paper-button>
                    </div>
                </paper-dialog>
                  

            </app-header-layout>
        </app-drawer-layout>
    </template>

    <script>
        Polymer.setPassiveTouchGestures(true);

        class MyApp extends Polymer.Element {
            static get is() {
                return 'my-app';
            }

            static get properties() {
                return {
                    user: {
                        type: Object,
                        default: null
                    },
                    page: {
                        type: String,
                        reflectToAttribute: true,
                        observer: '_pageChanged',
                    },
                    routeData: Object,
                    subroute: Object,
                    rootPath: String,
                    narrow: {
                        type: Boolean,
                        value: false
                    },
                    drawerMinimized: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true
                    }
                };
            }

            connectedCallback() {
                super.connectedCallback();
                this.addEventListener('require-toast', config => this._onRequireToast(config));
                this.addEventListener('require-dialog', config => this._onRequireDialog(config));
            }

            disconnectedCallback() {
                super.disconnectedCallback();
                this.removeEventListener('require-toast', this._onRequireToast);
                this.removeEventListener('require-dialog', this._onRequireDialog);
            }


            getUser() {
                return this.$.auth.signedIn;
            }

            static get observers() {
                return [
                    '_routePageChanged(routeData.page)'
                ];
            }

            _routePageChanged(page) {
                this.page = page || 'dashboard';

                if (!this.$.drawer.persistent) {
                    this.$.drawer.close();
                }
            }

            _pageChanged(page) {
                const resolvedPageUrl = this.resolveUrl('pages/page-' + page + '.html');
                Polymer.importHref(
                    resolvedPageUrl,
                    null,
                    this._showPage404.bind(this),
                    true);
            }

            _showPage404() {
                this.page = 'not-found';
            }

            toggleDrawer() {
                this.drawerClosed = !this.drawerClosed;
            }

            toggleDrawerMinimization() {
                this.drawerMinimized = !this.drawerMinimized;
            }

            _onRequireToast(properties) {
                console.log('--- TOAST REQUESTED ---');
                console.log(properties.detail.toastConfigs);
                for (var config in properties.detail.toastConfigs) {
                    this.$.mainToast[config] =  properties.detail.toastConfigs[config];
                }
                this.$.mainToast.open();
            }

            _onRequireDialog(properties) {
                console.log('--- MODAL REQUESTED ---');
                for (var config in properties.detail.dialogConfigs) {
                    this.$.mainDialog[config] =  properties.detail.dialogConfigs[config];
                }
                this.$.mainDialog.open();
            }
        }

        window.customElements.define(MyApp.is, MyApp);
    </script>
</dom-module>