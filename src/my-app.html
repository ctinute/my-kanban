<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/lazy-imports/lazy-imports-mixin.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">


<link rel="import" href="./shared-styles.html">
<link rel="import" href="./components/drawer/mk-drawer.html">
<link rel="import" href="./redux-mixin.html">
<link rel="lazy-import" href="./pages/page-login.html">
<link rel="lazy-import" href="./pages/page-not-found.html">
<link rel="lazy-import" href="./pages/page-dashboard.html">


<dom-module id="my-app">

    <link rel="lazy-import" group="project-init-dialog" href="./pages/modules/project-init-dialog.html">

    <template>
        <style include="shared-styles">
            :host {
                display: block;
                color: var(--mk-primary-color);
                --app-drawer-width: 256px;
                --app-header-height: 48px;
                --paper-toast-color: #FFF;
            }

            :host([drawer-minimized]) {
                --app-drawer-width: 48px;
            }

            :host([narrow]) {
                --app-drawer-width: 256px;
            }

            app-drawer,
            app-header-layout {
                transition: all 0.5s;
                overflow: hidden;
            }

            iron-pages {
                width: 100%;
                height: 100vh;
            }
        </style>

        <!-- Firebase config -->
        <firebase-app 
            auth-domain="projectmykanban.firebaseapp.com" 
            database-url="https://projectmykanban.firebaseio.com/" 
            api-key="AIzaSyBSuh-1xzT6XsxP7CGNZxzjSdP-0wyFvgk"
            storage-bucket="projectmykanban.appspot.com" 
            messaging-sender-id="63907430852">
        </firebase-app>

        <!-- Firebase Authentication -->
        <firebase-auth 
            id="auth" 
            user="{{user}}">
        </firebase-auth>

        <!-- Router -->
        <app-location 
            route="{{route}}" 
            url-space-regex="^[[rootPath]]">
        </app-location>

        <app-route route="{{route}}" pattern="[[rootPath]]:page" data="{{routeData}}" tail="{{subroute}}">
        </app-route>

        <!-- App local storage -->
        <app-localstorage-document key="drawerMinimization" data="{{drawerMinimized}}">
        </app-localstorage-document>


        <!-- MAIN APP -->

        <app-drawer-layout fullbleed narrow="{{narrow}}">

            <!-- Drawer content -->
            <app-drawer id="drawer" slot="drawer" swipe-open="[[narrow]]">
                <mk-drawer minimized="{{drawerMinimized}}" narrow="[[narrow]]" drawer-items="[[drawerItems]]"></mk-drawer>
            </app-drawer>

            <!-- Main content -->
            <app-header-layout has-scrolling-region>

                <!-- a global header on moblie -->
                <template is="dom-if" if="[[narrow]]">
                    <app-header class="app-shadow-4" slot="header" condenses reveals effects="waterfall">
                        <app-toolbar>
                            <paper-icon-button icon="icons:menu" drawer-toggle></paper-icon-button>
                            <div main-title>My App</div>
                        </app-toolbar>
                    </app-header>
                </template>

                <!-- All possible pages for lazy load -->
                <iron-pages selected="[[page]]" attr-for-selected="name" fallback-selection="not-found" role="main">
                    <page-not-found name="not-found"></page-not-found>
                    <page-login name="login"></page-login>
                    <page-dashboard name="dashboard"></page-dashboard>
                </iron-pages>


            </app-header-layout>
        </app-drawer-layout>


        <!-- global attention -->
        <paper-toast id="mainToast"></paper-toast>
        <paper-dialog id="mainDialog" modal></paper-dialog>

        <paper-toast 
            id="globalToast" 
            opened="[[globalToast.show]]" 
            text="[[globalToast.message]]" 
            duration="[[globalToast.duration]]" 
            on-opened-changed="_onToastStateChanged"
            horizontal-align="right">
        </paper-toast>

        <project-init-dialog id="project-init-dialog"></project-init-dialog>

    </template>

    <script>
        Polymer.setPassiveTouchGestures(true);

        class MyApp extends Polymer.LazyImportsMixin(ReduxMixin(Polymer.Element)) {
            static get is() {
                return 'my-app';
            }

            static get properties() {
                return {
                    user: {
                        type: Object,
                        default: null
                    },
                    page: {
                        type: String,
                        reflectToAttribute: true,
                        observer: '_pageChanged',
                    },
                    drawerItems: {
                        type: Object,
                        value: [{
                            title: 'Dashboard',
                            icon: 'icons:dashboard',
                            link: 'dashboard'
                        }]
                    },
                    routeData: Object,
                    subroute: Object,
                    rootPath: String,
                    narrow: {
                        type: Boolean,
                        value: false
                    },
                    drawerMinimized: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true
                    },
                    globalToast: {
                        type: Object,
                        statePath: 'app.globalToast'
                    }
                };
            }

            static get actions() {
                return {
                    dismissToast() {
                        return {
                            type: 'APP_GLOBAL_TOAST_DISMISS'
                        };
                    }
                };
            }

            connectedCallback() {
                super.connectedCallback();
                this.addEventListener('require-toast', config => this._onRequireToast(config));
                this.addEventListener('require-dialog', config => this._onRequireDialog(config));
            }

            disconnectedCallback() {
                super.disconnectedCallback();
                this.removeEventListener('require-toast', this._onRequireToast);
                this.removeEventListener('require-dialog', this._onRequireDialog);
            }

            static get observers() {
                return [
                    '_routePageChanged(routeData.page)'
                ];
            }

            _routePageChanged(page) {
                this.page = page || 'dashboard';

                if (!this.$.drawer.persistent) {
                    this.$.drawer.close();
                }
            }

            _pageChanged(page) {
                const resolvedPageUrl = this.resolveUrl('pages/page-' + page + '.html');
                Polymer.importHref(
                    resolvedPageUrl,
                    null,
                    this._showPage404.bind(this),
                    true);
            }

            _showPage404() {
                this.page = 'not-found';
            }

            toggleDrawer() {
                this.drawerClosed = !this.drawerClosed;
            }

            toggleDrawerMinimization() {
                this.drawerMinimized = !this.drawerMinimized;
            }

            _onRequireToast(properties) {
                console.log('--- TOAST REQUESTED ---');
                console.log(properties.detail);
                for (var config in properties.detail.toastConfigs) {
                    this.$.mainToast[config] = properties.detail.toastConfigs[config];
                }
                this.$.mainToast.open();
            }

            _onRequireDialog(properties) {
                console.log('--- MODAL REQUESTED ---');
                console.log(properties.detail);
                if (properties.detail.modalId) {
                    this.importLazyGroup(properties.detail.modalId).then((results) => {
                        this.$[properties.detail.modalId].open();
                    });

                }
            }

            _onToastStateChanged(e) {
                if (!this.$.globalToast.opened) {
                    this.dispatch('dismissToast')
                }
            }
        }

        window.customElements.define(MyApp.is, MyApp);
    </script>
</dom-module>